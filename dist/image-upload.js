"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),YuanImageUpload=function(){function e(t,n){_classCallCheck(this,e);var i=t.getAttribute("data-preview"),o=t.getAttribute("data-input");this.fileControl=t,this.previewContainer=document.getElementById(i),this.inputControl=document.getElementById(o),this.setDefaultOptions(),this.parseOptions(n),this.setInputControlPredefinedValue(),this.createPrefinedImgContainers(),this.addEventListeners()}return _createClass(e,[{key:"setDefaultOptions",value:function(){this.options={allowedExtensions:["gif","png","jpg","jpeg","bmp"],bgImagePlaceholder:"",imgIds:[],imgURLs:[],maxFiles:0,maxSizeEachFile:10485760,onFileTypeInvalid:function(){},onMaxFileReached:function(){},onMaxSizeReached:function(){},onPreview:function(){},onRemoveImage:function(){},onUploadComplete:function(){},onUploadError:function(){},parser:function(){},removeIconUrl:"../images/del.png",uploadURL:""}}},{key:"parseOptions",value:function(t){if(!t)return!1;var n=this.fileControl.getAttribute("data-maxfiles");n&&!isNaN(n)&&(this.options.maxFiles=parseInt(n)),e.extend(this.options,t)}},{key:"setInputControlPredefinedValue",value:function(){this.options.imgIds.length&&(this.inputControl.value=this.options.imgIds.join(";"))}},{key:"createPrefinedImgContainers",value:function(){if(this.options.imgURLs.length)for(var t=0,n=this.options.imgURLs.length;t<n;t++){var i=e.generateUUID();this.createImgContainer(this.options.imgURLs[t],i),document.getElementById(i).setAttribute("data-imgid",this.options.imgIds[t])}}},{key:"addEventListeners",value:function(){var e=this;this.fileControl.addEventListener("change",function(t){t.preventDefault(),t.stopPropagation(),e.handleFiles()},!1),this.previewContainer.addEventListener("click",function(t){t.stopPropagation(),t.preventDefault();var n=t.target,i=n.classList;i.contains("removeIcon")?e.handleRemoveImage(n.parentElement||n.parentNode):i.contains("imgContainer")&&e.previewImg(n.id)});var t=window.navigator.buildID&&parseInt(window.navigator.buildID,10)<20130714e6,n=this.fileControl.id;if(n){var i=document.querySelector('label[for="'+n+'"]');i&&(i.addEventListener("click",function(t){e.isMaxFilesReached()&&(t.stopPropagation(),t.preventDefault()),e.handleMaxFileReached()},!1),t&&i.addEventListener("click",function(t){t.stopPropagation(),t.preventDefault(),e.fileControl.click()},!1))}}},{key:"addEventListener",value:function(e,t){this.fileControl.addEventListener(e,t,!1)}},{key:"removeEventListener",value:function(e,t){this.fileControl.removeEventListener(e,t,!1)}},{key:"trigger",value:function(e,t){var n=new CustomEvent(e,{detail:t||null});this.fileControl.dispatchEvent(n)}},{key:"handleMaxFileReached",value:function(){this.isMaxFilesReached()&&this.options.onMaxFileReached&&this.options.onMaxFileReached.call(this)}},{key:"isMaxFilesReached",value:function(){return this.options.maxFiles&&this.inputControl.value.trim()&&this.inputControl.value.split(";").length>=this.options.maxFiles}},{key:"previewImg",value:function(e){this.options.onPreview&&this.options.onPreview.call(this,e)}},{key:"handleRemoveImage",value:function(e){var t=e.getAttribute("data-imgid");e.parentNode.removeChild(e);var n=this.inputControl.value.trim();if(n){var i=n.split(";"),o=i.indexOf(t);o>-1&&i.splice(o,1),this.inputControl.value=i.join(";")}this.options.onRemoveImage&&this.options.onRemoveImage.call(this)}},{key:"handleFiles",value:function(){for(var t=this.fileControl.files,n=t.length,i=0;i<n;i++){var o=t[i],a=/^image\//;if(o.size>this.options.maxSizeEachFile)1===n&&this.options.onMaxSizeReached&&this.options.onMaxSizeReached.call(this,o);else if(a.test(o.type)){var s=o.name.split(".").pop();if(this.options.allowedExtensions.indexOf(s)!==-1){var l=e.generateUUID();this.createImgContainer(o,l),this.sendFile(o,l)}else 1===n&&this.options.onFileTypeInvalid&&this.options.onFileTypeInvalid.call(this,o)}else 1===n&&this.options.onFileTypeInvalid&&this.options.onFileTypeInvalid.call(this,o)}}},{key:"createImgContainer",value:function(e,t){var n=document.createElement("div");n.classList.add("imgContainer"),n.id=t;var i=document.createElement("img");if(i.src=this.options.removeIconUrl,i.classList.add("removeIcon"),"string"==typeof e){var o="url("+e+")";this.options.bgImagePlaceholder&&(o+=", url("+this.options.bgImagePlaceholder+")"),n.style.backgroundImage=o}else{var a=new FileReader;a.onload=function(e){n.style.backgroundImage="url("+e.target.result+")"},a.readAsDataURL(e)}n.appendChild(i),this.previewContainer.appendChild(n)}},{key:"sendFile",value:function(e,t){var n=this,i=new XMLHttpRequest,o=new FormData;i.open("POST",this.options.uploadURL,!0),i.onreadystatechange=function(){if(4==i.readyState)if(200==i.status){var e=JSON.parse(i.responseText);n.handleUploadResponse(e,t),n.trigger("uploaded",{responseJSON:e,fileLocalId:t})}else n.trigger("errorupload",{xhr:i,fileLocalId:t})};var a=this.fileControl.getAttribute("name")||"myFile";o.append(a,e),i.send(o)}},{key:"handleUploadResponse",value:function(e,t){if(this.options.parser){var n=this.options.parser.call(this,e);this._handleUploadSuccess(n,t),!n&&this.options.onUploadError&&this.options.onUploadError.call(this,t),this.options.onUploadComplete&&this.options.onUploadComplete.call(this,t)}}},{key:"_handleUploadSuccess",value:function(e,t){this.inputControl.value?this.inputControl.value+=";"+e:this.inputControl.value=e,document.getElementById(t).setAttribute("data-imgid",e)}}],[{key:"generateUUID",value:function(){var e=(new Date).getTime(),t="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var n=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"==t?n:7&n|8).toString(16)});return t}},{key:"extend",value:function(){for(var e=1;e<arguments.length;e++)for(var t in arguments[e])arguments[e].hasOwnProperty(t)&&(arguments[0][t]=arguments[e][t]);return arguments[0]}}]),e}();!function(){function e(e,t){t=t||{bubbles:!0,cancelable:!0,detail:void 0},"undefined"==typeof t.bubbles&&(t.bubbles=!0),"undefined"==typeof t.cancelable&&(t.cancelable=!0);var n;try{n=document.createEvent("CustomEvent"),n.initCustomEvent(e,t.bubbles,t.cancelable,t.detail)}catch(i){n=document.createEvent("Event"),n.initEvent(e,t.bubbles,t.cancelable),n.detail=t.detail}return n}e.prototype=window.Event.prototype,window.CustomEvent=e}();